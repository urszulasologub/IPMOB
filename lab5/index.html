<!DOCTYPE html>
<head>
<script>
  window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
  window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction || {READ_WRITE: "readwrite"}; // This line should only be needed if it is needed to support the object's constants for older browsers
  window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;

  if (!window.indexedDB) {
    window.alert("Your browser doesn't support a stable version of IndexedDB. Such and such feature will not be available.");
  }

function init(){
  var request = window.indexedDB.open("ClientDatabase", 1);
  request.onerror = function(event) {
    alert("Error faced while opening database");
  };
  request.onsuccess = function(event) {
    db = event.target.result;
    db.onerror = function(event) {
      alert("Database error: " + event.target.errorCode);
    };
    updatetable();
  };

  request.onupgradeneeded = function(event) {  
    var db = event.target.result;
    var objectStore = db.createObjectStore("clients", {keyPath: "id", autoIncrement: true});
    objectStore.createIndex("name", "name", {unique:false});
    objectStore.createIndex("surname", "surname", {unique:false});
    objectStore.createIndex("email", "email", {unique:false});
    objectStore.transaction.oncomplete = function(event) {
      
    };
  };

  document.getElementById('addButton').onclick = function(e) {

    var bname = document.getElementById('nameInput').value;
    var bsurname = document.getElementById('surnameInput').value;
    var bemail = document.getElementById('emailInput').value;

    if (!bname || !bsurname || !bemail) {
      window.alert("Fill the form correctly!");
      return;
    }

    const book_item = {
      name: bname,
      surname: bsurname,
      email: bemail
    }

    var transaction = db.transaction(["clients"], "readwrite");

    transaction.oncomplete = function(event) {
      console.log("all done with transaction");
    };

    transaction.onerror = function(event){
      console.dir(event);
    };

    var clientsObjectStore = transaction.objectStore("clients");

    var request = clientsObjectStore.add(book_item);

    request.onsuccess = function(event){
      console.log("added item");
    };

    updatetable();

  }

  document.getElementById('delButton').onclick = function(e){

    var id_del = document.getElementById('idDelInput').value;

    var request = db.transaction(["clients"], "readwrite").objectStore("clients").delete(id_del);

    request.onsuccess = function(event){
      console.log(id_del+" deleted");
    }

    updatetable();
  }

  function updatetable(){

    document.getElementById("clients-table-body").innerHTML = "";

    var request = db.transaction("clients").objectStore("clients").openCursor();

    request.onerror = function(event){
      console.dir(event);
    };

    request.onsuccess = function(event){

      cursor = event.target.result;

      if(cursor) {
        document.getElementById("clients-table-body").innerHTML += "<tr><td>" + cursor.value.name + "</td><td>"
          + cursor.value.surname + "</td><td>" + cursor.value.email + "</td><td>" + cursor.key + "</td></tr>";

          cursor.continue();
      }
    };
  }
}

</script>
</head>

<body onload="init()">
  
    <h1>IndexedDB Example</h1>

    <p>
        <fieldset id="addForm">
            <legend>Add item</legend>
            <label>Name</label>
            <input id="nameInput" required>
            <label>surname</label>
            <input id="surnameInput" required>
            <label>email</label>
            <input type="email" id="emailInput" required>
            <button id="addButton">Add</button>
        </fieldset>
    </p>

    <p>
      <fieldset id="deleteForm">
        <legend>Delete item</legend>
        <label>id</label>
        <input id="idDelInput">
        <button id="delButton">Delete</button>
      </fieldset>
    </p>

    <table id="clients-table">
        <thead>
            <tr><th>Name</th><th>surname</th><th>email</th><th>id</th></tr>
        </thead>
        <tbody id="clients-table-body">
        </tbody>
    </table>

</body>
</html>
